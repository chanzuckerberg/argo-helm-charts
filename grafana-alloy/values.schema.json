{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "argo.helm.charts/grafana-alloy",
  "title": "grafana-alloy",
  "type": "object",
  "required": [
    "clusterName"
  ],
  "properties": {
    "alloy": {
      "type": "object",
      "properties": {
        "affinity": {
          "description": "Affinity rules for pod assignment",
          "type": "object"
        },
        "alloy": {
          "description": "Alloy deployment configuration",
          "type": "object",
          "properties": {
            "clustering": {
              "description": "Clustering configuration",
              "type": "object",
              "properties": {
                "enabled": {
                  "description": "Enable clustering mode",
                  "type": "boolean"
                }
              }
            },
            "configMap": {
              "description": "ConfigMap configuration for Alloy",
              "type": "object",
              "properties": {
                "create": {
                  "description": "Whether to create the default ConfigMap (false since we create our own)",
                  "type": "boolean"
                },
                "key": {
                  "description": "Key in the ConfigMap containing the configuration",
                  "type": "string"
                },
                "name": {
                  "description": "Name of the ConfigMap to use",
                  "type": "string"
                }
              }
            },
            "extraArgs": {
              "description": "Extra arguments to pass to Alloy",
              "type": "array"
            },
            "extraEnv": {
              "description": "Extra environment variables",
              "type": "array"
            },
            "extraPorts": {
              "description": "Extra ports to expose",
              "type": "array"
            },
            "image": {
              "description": "Alloy container image configuration",
              "type": "object",
              "properties": {
                "pullPolicy": {
                  "description": "Image pull policy",
                  "type": "string",
                  "enum": [
                    "Always",
                    "IfNotPresent",
                    "Never"
                  ]
                },
                "registry": {
                  "description": "Container registry for Alloy image",
                  "type": "string"
                },
                "repository": {
                  "description": "Container image repository",
                  "type": "string"
                }
              }
            },
            "stabilityLevel": {
              "description": "Stability level for Alloy features",
              "type": "string",
              "enum": [
                "experimental",
                "public-preview",
                "generally-available"
              ]
            }
          }
        },
        "configReloader": {
          "description": "Config reloader configuration",
          "type": "object",
          "properties": {
            "enabled": {
              "description": "Enable config reloader",
              "type": "boolean"
            }
          }
        },
        "controller": {
          "description": "Controller configuration",
          "type": "object",
          "properties": {
            "replicas": {
              "description": "Number of replicas (only for deployment/statefulset)",
              "type": "integer"
            },
            "type": {
              "description": "Type of controller to use",
              "type": "string",
              "enum": [
                "daemonset",
                "deployment",
                "statefulset"
              ]
            }
          }
        },
        "ingress": {
          "description": "Ingress configuration",
          "type": "object",
          "properties": {
            "annotations": {
              "description": "Annotations for the ingress",
              "type": "object"
            },
            "enabled": {
              "description": "Enable ingress",
              "type": "boolean"
            },
            "hosts": {
              "description": "Ingress hosts",
              "type": "array"
            },
            "tls": {
              "description": "TLS configuration",
              "type": "array"
            }
          }
        },
        "nodeSelector": {
          "description": "Node selector for pod assignment",
          "type": "object"
        },
        "podAnnotations": {
          "description": "Pod annotations",
          "type": "object"
        },
        "podLabels": {
          "description": "Pod labels",
          "type": "object"
        },
        "podSecurityContext": {
          "description": "Pod security context",
          "type": "object"
        },
        "rbac": {
          "description": "RBAC configuration",
          "type": "object",
          "properties": {
            "create": {
              "description": "Create RBAC resources",
              "type": "boolean"
            }
          }
        },
        "resources": {
          "description": "Resource requests and limits",
          "type": "object",
          "properties": {
            "limits": {
              "type": "object",
              "properties": {
                "cpu": {
                  "description": "CPU limit (e.g., \"200m\", \"1\", \"2\")",
                  "anyOf": [
                    {
                      "type": "string"
                    },
                    {
                      "type": "number"
                    }
                  ]
                },
                "memory": {
                  "description": "Memory limit",
                  "type": "string"
                }
              }
            },
            "requests": {
              "type": "object",
              "properties": {
                "cpu": {
                  "description": "CPU request (e.g., \"200m\", \"1\", \"2\")",
                  "anyOf": [
                    {
                      "type": "string"
                    },
                    {
                      "type": "number"
                    }
                  ]
                },
                "memory": {
                  "description": "Memory request",
                  "type": "string"
                }
              }
            }
          }
        },
        "securityContext": {
          "description": "Container security context",
          "type": "object",
          "properties": {
            "allowPrivilegeEscalation": {
              "description": "Prevent privilege escalation",
              "type": "boolean"
            },
            "readOnlyRootFilesystem": {
              "description": "Mount root filesystem as read-only",
              "type": "boolean"
            },
            "runAsNonRoot": {
              "description": "Run container as non-root user",
              "type": "boolean"
            }
          }
        },
        "service": {
          "description": "Service configuration",
          "type": "object",
          "properties": {
            "enabled": {
              "description": "Enable the service",
              "type": "boolean"
            },
            "type": {
              "description": "Service type",
              "type": "string"
            }
          }
        },
        "serviceAccount": {
          "description": "Service account configuration",
          "type": "object",
          "properties": {
            "annotations": {
              "description": "Annotations to add to the service account",
              "type": "object"
            },
            "create": {
              "description": "Create a service account",
              "type": "boolean"
            },
            "name": {
              "description": "Name of the service account",
              "type": "string"
            }
          }
        },
        "tolerations": {
          "description": "Tolerations for pod assignment",
          "type": "array"
        }
      }
    },
    "alloyConfig": {
      "type": "object",
      "properties": {
        "beyla": {
          "description": "Enable Beyla integration for eBPF-based application instrumentation",
          "type": "object",
          "properties": {
            "enabled": {
              "description": "Enable Beyla integration (requires prometheusRemoteWrite.enabled=true)",
              "type": "boolean"
            }
          }
        },
        "content": {
          "description": "Custom Alloy configuration content (River format). If empty, uses default collection config.",
          "type": "string"
        },
        "events": {
          "description": "Enable Kubernetes events collection",
          "type": "object",
          "properties": {
            "enabled": {
              "description": "Enable collection of Kubernetes events",
              "type": "boolean"
            }
          }
        },
        "metrics": {
          "description": "Enable Prometheus metrics collection",
          "type": "object",
          "properties": {
            "enabled": {
              "description": "Enable scraping of Prometheus metrics from pods (requires prometheusRemoteWrite.enabled=true)",
              "type": "boolean"
            }
          }
        },
        "podLogs": {
          "description": "Enable pod log collection",
          "type": "object",
          "properties": {
            "enabled": {
              "description": "Enable collection of pod logs from all nodes",
              "type": "boolean"
            }
          }
        },
        "traces": {
          "description": "Enable trace collection and export",
          "type": "object",
          "properties": {
            "enabled": {
              "description": "Enable trace collection and export to Tempo (requires tempo.enabled=true)",
              "type": "boolean"
            },
            "k8sMetadata": {
              "description": "Attach Kubernetes metadata to traces using k8sattributes processor",
              "type": "object",
              "properties": {
                "enabled": {
                  "description": "Enable Kubernetes metadata enrichment for traces",
                  "type": "boolean"
                },
                "extract": {
                  "description": "List of Kubernetes metadata attributes to extract",
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                }
              }
            },
            "healthCheckFilter": {
              "description": "Filter out noisy health check spans from traces",
              "type": "object",
              "properties": {
                "enabled": {
                  "description": "Enable filtering of health check endpoints",
                  "type": "boolean"
                },
                "routes": {
                  "description": "List of HTTP routes to filter out (exact match on http.route attribute)",
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                }
              }
            },
            "spanMetrics": {
              "description": "Generate RED metrics (Rate, Errors, Duration) from traces",
              "type": "object",
              "properties": {
                "enabled": {
                  "description": "Enable span metrics generation (requires prometheusRemoteWrite.enabled=true)",
                  "type": "boolean"
                },
                "namespace": {
                  "description": "Metrics namespace for easier querying",
                  "type": "string"
                },
                "dimensions": {
                  "description": "Dimensions to include in generated metrics",
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                },
                "histogramBuckets": {
                  "description": "Histogram buckets for latency distribution",
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                }
              }
            },
            "serviceGraph": {
              "description": "Generate service dependency graph metrics from traces",
              "type": "object",
              "properties": {
                "enabled": {
                  "description": "Enable service graph metrics (requires prometheusRemoteWrite.enabled=true)",
                  "type": "boolean"
                },
                "dimensions": {
                  "description": "Dimensions to include in service graph metrics",
                  "type": "array",
                  "items": {
                    "type": "string"
                  }
                }
              }
            }
          }
        }
      }
    },
    "clusterName": {
      "description": "Name of the cluster where this chart is deployed. This value is required.",
      "type": "string"
    },
    "enabled": {
      "description": "Enable or disable the Grafana Alloy deployment",
      "type": "boolean"
    },
    "loki": {
      "type": "object",
      "properties": {
        "endpoints": {
          "description": "List of Loki endpoints to send logs to",
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "url": {
                "description": "URL of the Loki endpoint",
                "type": "string"
              }
            }
          }
        }
      }
    },
    "prometheusRemoteWrite": {
      "type": "object",
      "properties": {
        "enabled": {
          "description": "Enable Prometheus remote write",
          "type": "boolean"
        },
        "endpoints": {
          "description": "Array of remote write endpoints",
          "type": "array"
        },
        "metricsFilter": {
          "description": "Metrics filtering configuration",
          "type": "object",
          "properties": {
            "enabled": {
              "description": "Enable metrics filtering",
              "type": "boolean"
            },
            "regex": {
              "description": "Regex pattern to match metric names to keep",
              "type": "string"
            }
          }
        }
      }
    },
    "tempo": {
      "type": "object",
      "properties": {
        "enabled": {
          "description": "Enable trace export to Tempo",
          "type": "boolean"
        },
        "endpoints": {
          "description": "Array of Tempo endpoints to send traces to",
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "url": {
                "description": "URL of the Tempo OTLP endpoint (host:port)",
                "type": "string"
              },
              "protocol": {
                "description": "Protocol to use for the Tempo endpoint",
                "type": "string",
                "enum": ["grpc", "http"],
                "default": "grpc"
              },
              "tls": {
                "description": "TLS configuration",
                "type": "object",
                "properties": {
                  "insecure": {
                    "description": "Disable TLS verification (for in-cluster communication)",
                    "type": "boolean"
                  },
                  "insecureSkipVerify": {
                    "description": "Skip TLS certificate verification",
                    "type": "boolean"
                  }
                }
              },
              "basicAuth": {
                "description": "Basic authentication for Tempo endpoint",
                "type": "object",
                "properties": {
                  "username": {
                    "description": "Username for basic auth",
                    "type": "string"
                  },
                  "password": {
                    "description": "Password for basic auth",
                    "type": "string"
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
