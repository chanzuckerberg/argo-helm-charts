suite: test configmap.yaml
templates:
  - configmap.yaml

tests:
  - it: should not render anything if .Values.enabled is false
    set:
      enabled: false
      clusterName: test-cluster
    asserts:
      - hasDocuments:
          count: 0

  - it: should render a ConfigMap when enabled
    set:
      enabled: true
      clusterName: test-cluster
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ConfigMap

  - it: should have the correct name
    set:
      enabled: true
      clusterName: test-cluster
    asserts:
      - equal:
          path: metadata.name
          value: grafana-alloy-config

  - it: should contain config.alloy key in data
    set:
      enabled: true
      clusterName: test-cluster
    asserts:
      - isNotEmpty:
          path: data["config.alloy"]

  - it: should include cluster name in default configuration
    set:
      enabled: true
      clusterName: my-production-cluster
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'cluster\s*=\s*"my-production-cluster"'

  - it: should include local loki endpoint in default configuration
    set:
      enabled: true
      clusterName: test-cluster
      loki:
        local:
          url: "http://loki.loki.svc:3100/loki/api/v1/push"
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'http://loki\.loki\.svc:3100/loki/api/v1/push'

  - it: should include central loki endpoint when enabled
    set:
      enabled: true
      clusterName: test-cluster
      loki:
        endpoints:
          - url: "http://loki.loki.svc:3100/loki/api/v1/push"
          - url: "https://loki-gateway.example.com/loki/api/v1/push"
            basicAuth:
              envVar: "BASIC_AUTH_CREDENTIALS"
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'https://loki-gateway\.example\.com/loki/api/v1/push'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'BASIC_AUTH_CREDENTIALS'

  - it: should not include central loki endpoint when disabled
    set:
      enabled: true
      clusterName: test-cluster
      loki:
        endpoints:
          - url: "http://loki.loki.svc:3100/loki/api/v1/push"
    asserts:
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'BASIC_AUTH_CREDENTIALS'

  - it: should use custom basicAuthEnvVar when provided
    set:
      enabled: true
      clusterName: test-cluster
      loki:
        endpoints:
          - url: "http://loki.loki.svc:3100/loki/api/v1/push"
          - url: "https://loki-gateway.example.com/loki/api/v1/push"
            basicAuth:
              envVar: "CUSTOM_AUTH_CREDENTIALS"
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'CUSTOM_AUTH_CREDENTIALS'
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'BASIC_AUTH_CREDENTIALS'

  - it: should include kubernetes events source in default config
    set:
      enabled: true
      clusterName: test-cluster
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'loki\.source\.kubernetes_events'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'kubernetes-events'

  - it: should include relabeling configuration in default config
    set:
      enabled: true
      clusterName: test-cluster
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'loki\.relabel "rename_namespace"'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'event_namespace'

  - it: should include label processing in default config
    set:
      enabled: true
      clusterName: test-cluster
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'loki\.process "add_event_labels"'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'exporter = "grafana-alloy"'

  - it: should have the correct labels
    set:
      enabled: true
      clusterName: test-cluster
    asserts:
      - isNotEmpty:
          path: metadata.labels
      - matchRegex:
          path: metadata.labels["helm.sh/chart"]
          pattern: grafana-alloy-.*
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: grafana-alloy

  - it: should use custom configuration when provided
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        content: |
          logging {
            level = "debug"
          }
          custom_component "test" {}
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'level = "debug"'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'custom_component "test"'
      # Should not contain default kubernetes_events config when custom is provided
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'loki\.source\.kubernetes_events'
  - it: should not enable beyla when alloyConfig.beyla.enabled is not set
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        podLogs:
          enabled: false
    asserts:
      - isKind:
          of: ConfigMap
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'beyla\.ebpf'
  - it: should not enable beyla when alloyConfig.beyla.enabled is set but prometheusRemoteWrite is not enabled
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        beyla:
          enabled: true
    asserts:
      - isKind:
          of: ConfigMap
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'beyla\.ebpf'
  - it: should enable beyla when alloyConfig.beyla.enabled and prometheusRemoteWrite.enabled are true
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        beyla:
          enabled: true
          namespace: "my-app-ns"
      prometheusRemoteWrite:
        enabled: true
        endpoints:
          - url: http://prometheus.svc/api/v1/write
          - url: http://central-loki-stack
    asserts:
      - isKind:
          of: ConfigMap
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'beyla\.ebpf\s+"default"'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'namespace = "my-app-ns"'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'traces = \[\]'
  - it: should allow all namespace if alloyConfig.beyla.namespace is not set
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        beyla:
          enabled: true
      prometheusRemoteWrite:
        enabled: true
        endpoints:
          - url: http://prometheus.svc/api/v1/write
    asserts:
      - isKind:
          of: ConfigMap
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'beyla\.ebpf\s+"default"'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'namespace = ".*"'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'traces = \[\]'
  - it: should configure basic_auth for prometheusRemoteWrite when basicAuth is provided
    set:
      enabled: true
      clusterName: test-cluster
      prometheusRemoteWrite:
        enabled: true
        endpoints:
          - url: http://local-prometheus.svc/api/v1/write
          - url: https://mimir.example.com/api/v1/push
            basicAuth:
              usernameEnvVar: "MIMIR_USERNAME"
              passwordEnvVar: "MIMIR_PASSWORD"
            externalLabels:
              exporter: grafana-alloy
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'basic_auth'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'username = env\("MIMIR_USERNAME"\)'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'password = env\("MIMIR_PASSWORD"\)'
  - it: should not include basic_auth when basicAuth is not provided for prometheusRemoteWrite
    set:
      enabled: true
      clusterName: test-cluster
      prometheusRemoteWrite:
        enabled: true
        endpoints:
          - url: http://prometheus.svc/api/v1/write
    asserts:
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'basic_auth'

  - it: should support mixed basic auth configuration across multiple prometheusRemoteWrite endpoints
    set:
      enabled: true
      clusterName: test-cluster
      prometheusRemoteWrite:
        enabled: true
        endpoints:
          - url: http://local-prometheus.svc/api/v1/write
          - url: https://mimir.example.com/api/v1/push
            basicAuth:
              usernameEnvVar: "MIMIR_USERNAME"
              passwordEnvVar: "MIMIR_PASSWORD"
          - url: http://another-local.svc/api/v1/write
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'prometheus\.remote_write "endpoint_0"'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'prometheus\.remote_write "endpoint_1"'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'prometheus\.remote_write "endpoint_2"'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'http://local-prometheus\.svc/api/v1/write'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'https://mimir\.example\.com/api/v1/push'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'http://another-local\.svc/api/v1/write'
      # Basic auth should be present for the endpoint that has it configured
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'basic_auth'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'username = env\("MIMIR_USERNAME"\)'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'password = env\("MIMIR_PASSWORD"\)'

  - it: should use custom environment variable names for prometheusRemoteWrite basic auth
    set:
      enabled: true
      clusterName: test-cluster
      prometheusRemoteWrite:
        enabled: true
        endpoints:
          - url: https://cortex.example.com/api/v1/push
            basicAuth:
              usernameEnvVar: "CORTEX_USER"
              passwordEnvVar: "CORTEX_PASS"
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'username = env\("CORTEX_USER"\)'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'password = env\("CORTEX_PASS"\)'
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'MIMIR_USERNAME'
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'MIMIR_PASSWORD'

  - it: should not include basic_auth when only usernameEnvVar is provided
    set:
      enabled: true
      clusterName: test-cluster
      prometheusRemoteWrite:
        enabled: true
        endpoints:
          - url: https://mimir.example.com/api/v1/push
            basicAuth:
              usernameEnvVar: "MIMIR_USERNAME"
    asserts:
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'basic_auth'

  - it: should not include basic_auth when only passwordEnvVar is provided
    set:
      enabled: true
      clusterName: test-cluster
      prometheusRemoteWrite:
        enabled: true
        endpoints:
          - url: https://mimir.example.com/api/v1/push
            basicAuth:
              passwordEnvVar: "MIMIR_PASSWORD"
    asserts:
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'basic_auth'

  - it: should configure basic auth for all endpoints when all have basicAuth configured
    set:
      enabled: true
      clusterName: test-cluster
      prometheusRemoteWrite:
        enabled: true
        endpoints:
          - url: https://mimir-1.example.com/api/v1/push
            basicAuth:
              usernameEnvVar: "MIMIR1_USER"
              passwordEnvVar: "MIMIR1_PASS"
          - url: https://mimir-2.example.com/api/v1/push
            basicAuth:
              usernameEnvVar: "MIMIR2_USER"
              passwordEnvVar: "MIMIR2_PASS"
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'username = env\("MIMIR1_USER"\)'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'password = env\("MIMIR1_PASS"\)'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'username = env\("MIMIR2_USER"\)'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'password = env\("MIMIR2_PASS"\)'

  - it: should not render prometheusRemoteWrite endpoints when prometheusRemoteWrite.enabled is false
    set:
      enabled: true
      clusterName: test-cluster
      prometheusRemoteWrite:
        enabled: false
        endpoints:
          - url: https://mimir.example.com/api/v1/push
            basicAuth:
              usernameEnvVar: "MIMIR_USERNAME"
              passwordEnvVar: "MIMIR_PASSWORD"
    asserts:
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'prometheus\.remote_write'
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'basic_auth'
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'MIMIR_USERNAME'

  - it: should use default logging level (info) when not specified
    set:
      enabled: true
      clusterName: test-cluster
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'level\s*=\s*"info"'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'format\s*=\s*"logfmt"'

  - it: should configure custom logging level
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        logging:
          level: error
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'level\s*=\s*"error"'

  - it: should configure debug logging level
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        logging:
          level: debug
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'level\s*=\s*"debug"'

  - it: should configure warn logging level
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        logging:
          level: warn
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'level\s*=\s*"warn"'

  - it: should configure json log format
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        logging:
          format: json
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'format\s*=\s*"json"'

  - it: should configure both logging level and format
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        logging:
          level: error
          format: json
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'level\s*=\s*"error"'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'format\s*=\s*"json"'

  - it: should disable beyla debug by default
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        beyla:
          enabled: true
      prometheusRemoteWrite:
        enabled: true
        endpoints:
          - url: http://prometheus.svc/api/v1/write
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'beyla\.ebpf\s+"default"'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'debug = false'

  - it: should enable beyla debug when configured
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        beyla:
          enabled: true
          debug: true
      prometheusRemoteWrite:
        enabled: true
        endpoints:
          - url: http://prometheus.svc/api/v1/write
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'beyla\.ebpf\s+"default"'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'debug = true'

  - it: should explicitly disable beyla debug
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        beyla:
          enabled: true
          debug: false
      prometheusRemoteWrite:
        enabled: true
        endpoints:
          - url: http://prometheus.svc/api/v1/write
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'debug = false'

  - it: should enable scrapeKubeStateMetrics by default when metrics and prometheusRemoteWrite are enabled
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        metrics:
          enabled: true
      prometheusRemoteWrite:
        enabled: true
        endpoints:
          - url: http://prometheus.svc/api/v1/write
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'discovery\.kubernetes "kube_state_metrics_svc"'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'discovery\.relabel "kube_state_metrics"'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'prometheus\.scrape "kube_state_metrics"'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'names = \["kube-system"\]'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'label = "app\.kubernetes\.io/name=kube-state-metrics"'

  - it: should disable scrapeKubeStateMetrics when explicitly set to false
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        metrics:
          enabled: true
      prometheusRemoteWrite:
        enabled: true
        scrapeKubeStateMetrics:
          enabled: false
        endpoints:
          - url: http://prometheus.svc/api/v1/write
    asserts:
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'discovery\.kubernetes "kube_state_metrics_svc"'
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'prometheus\.scrape "kube_state_metrics"'

  - it: should not render scrapeKubeStateMetrics when metrics is disabled
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        metrics:
          enabled: false
      prometheusRemoteWrite:
        enabled: true
        scrapeKubeStateMetrics:
          enabled: true
        endpoints:
          - url: http://prometheus.svc/api/v1/write
    asserts:
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'discovery\.kubernetes "kube_state_metrics_svc"'
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'prometheus\.scrape "kube_state_metrics"'

  - it: should not render scrapeKubeStateMetrics when prometheusRemoteWrite is disabled
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        metrics:
          enabled: true
      prometheusRemoteWrite:
        enabled: false
        scrapeKubeStateMetrics:
          enabled: true
    asserts:
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'discovery\.kubernetes "kube_state_metrics_svc"'
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'prometheus\.scrape "kube_state_metrics"'

  - it: should use custom namespace for scrapeKubeStateMetrics
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        metrics:
          enabled: true
      prometheusRemoteWrite:
        enabled: true
        scrapeKubeStateMetrics:
          enabled: true
          namespace: "monitoring"
        endpoints:
          - url: http://prometheus.svc/api/v1/write
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'names = \["monitoring"\]'
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'names = \["kube-system"\]'

  - it: should use custom serviceSelector for scrapeKubeStateMetrics
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        metrics:
          enabled: true
      prometheusRemoteWrite:
        enabled: true
        scrapeKubeStateMetrics:
          enabled: true
          serviceSelector: "app=custom-ksm"
        endpoints:
          - url: http://prometheus.svc/api/v1/write
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'label = "app=custom-ksm"'
      - notMatchRegex:
          path: data["config.alloy"]
          pattern: 'label = "app\.kubernetes\.io/name=kube-state-metrics"'

  - it: should configure scrapeKubeStateMetrics with custom namespace and serviceSelector
    set:
      enabled: true
      clusterName: test-cluster
      alloyConfig:
        metrics:
          enabled: true
      prometheusRemoteWrite:
        enabled: true
        scrapeKubeStateMetrics:
          enabled: true
          namespace: "observability"
          serviceSelector: "app.kubernetes.io/instance=ksm-prod"
        endpoints:
          - url: http://prometheus.svc/api/v1/write
    asserts:
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'discovery\.kubernetes "kube_state_metrics_svc"'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'names = \["observability"\]'
      - matchRegex:
          path: data["config.alloy"]
          pattern: 'label = "app\.kubernetes\.io/instance=ksm-prod"'
