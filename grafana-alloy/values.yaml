# Grafana Alloy Helm Chart Values
# This chart deploys Grafana Alloy with customizable configuration

enabled: true # @schema description: Enable or disable the Grafana Alloy deployment

clusterName: "" # @schema description: Name of the cluster where this chart is deployed. This value is required.; required: true

# Loki endpoints configuration
loki:
  endpoints: # @schema description: List of Loki endpoints to send logs to
    - url: "http://loki.loki.svc:3100/loki/api/v1/push" # @schema description: URL of the Loki endpoint
      # basicAuth: # @schema description: Basic authentication configuration (optional)
      #   envVar: "BASIC_AUTH_CREDENTIALS" # @schema description: Name of the environment variable containing basic auth credentials

# Example with multiple endpoints:
# loki:
#   endpoints:
#     - url: "http://loki.loki.svc:3100/loki/api/v1/push"
#     - url: "https://loki.prod-central-o11y.prod.czi.team/loki/api/v1/push"
#       basicAuth:
#         envVar: "BASIC_AUTH_CREDENTIALS"

# Prometheus remote write configuration
prometheusRemoteWrite:
  enabled: false # @schema description: Enable Prometheus remote write
  endpoints: [] # @schema description: Array of remote write endpoints
    # - url: "" # @schema description: URL of the Prometheus remote write endpoint
    #   basicAuth: # @schema description: Basic authentication configuration (optional)
    #     usernameEnvVar: "MIMIR_USERNAME" # @schema description: Name of the environment variable containing username
    #     passwordEnvVar: "MIMIR_PASSWORD" # @schema description: Name of the environment variable containing password
    #   externalLabels: {} # @schema description: External labels to add to all metrics for this endpoint
    #   queueConfig: # @schema description: Queue configuration for remote write
    #     maxSamplesPerSend: 3000 # @schema description: Maximum samples per send
    #     batchSendDeadline: "10s" # @schema description: Batch send deadline
    #     minShards: 4 # @schema description: Minimum shards
    #     maxShards: 200 # @schema description: Maximum shards
    #     capacity: 10000 # @schema description: Queue capacity
    #   sigv4: # @schema description: SigV4 configuration for AWS authentication
    #     enabled: false # @schema description: Enable SigV4 authentication
    #     region: "" # @schema description: AWS region for SigV4
  metricsFilter: # @schema description: Metrics filtering configuration
    enabled: false # @schema description: Enable metrics filtering
    regex: "" # @schema description: Regex pattern to match metric names to keep

# Custom Alloy configuration to merge/override the default configmap
# This will be used to create a custom grafana-alloy-config ConfigMap
alloyConfig:
  # @schema description: Custom Alloy configuration content (River format). If empty, uses default collection config.
  # See https://grafana.com/docs/alloy/latest/reference/config-blocks/
  content: ""
  
  # @schema description: Enable pod log collection
  podLogs:
    enabled: true # @schema description: Enable collection of pod logs from all nodes
  
  # @schema description: Enable Kubernetes events collection
  events:
    enabled: true # @schema description: Enable collection of Kubernetes events
  
  # @schema description: Enable Prometheus metrics collection
  metrics:
    enabled: false # @schema description: Enable scraping of Prometheus metrics from pods (requires prometheusRemoteWrite.enabled=true)

  # @schema description: Enable Beyla integration for eBPF-based application instrumentation
  beyla:
    enabled: false # @schema description: Enable Beyla integration (requires prometheusRemoteWrite.enabled=true)

# Alloy subchart configuration
# Reference: https://github.com/grafana/alloy/tree/main/operations/helm/charts/alloy
alloy:
  # @schema description: Alloy deployment configuration
  alloy:
    # @schema description: Alloy container image configuration
    image:
      registry: docker.io # @schema description: Container registry for Alloy image
      repository: grafana/alloy # @schema description: Container image repository
      # tag: defaults to appVersion from alloy subchart # @schema description: Container image tag (Alloy version)
      pullPolicy: IfNotPresent # @schema enum: [Always, IfNotPresent, Never]; description: Image pull policy

    # @schema description: ConfigMap configuration for Alloy
    configMap:
      create: false # @schema description: Whether to create the default ConfigMap (false since we create our own)
      name: grafana-alloy-config # @schema description: Name of the ConfigMap to use
      key: config.alloy # @schema description: Key in the ConfigMap containing the configuration

    # @schema description: Extra arguments to pass to Alloy
    extraArgs: []

    # @schema description: Extra environment variables
    extraEnv: []

    # @schema description: Extra ports to expose
    extraPorts: []

    # @schema description: Clustering configuration
    clustering:
      enabled: false # @schema description: Enable clustering mode

    # @schema description: Stabilize outgoing connection when clustering is enabled
    stabilityLevel: generally-available # @schema description: Stability level for Alloy features; enum: [experimental, public-preview, generally-available]

  # @schema description: Controller configuration
  controller:
    type: deployment # @schema enum: [daemonset, deployment, statefulset]; description: Type of controller to use
    replicas: 1 # @schema description: Number of replicas (only for deployment/statefulset)

  # @schema description: Service configuration
  service:
    enabled: true # @schema description: Enable the service
    type: ClusterIP # @schema description: Service type

  # @schema description: Service account configuration
  serviceAccount:
    create: true # @schema description: Create a service account
    name: "grafana-alloy" # @schema description: Name of the service account
    annotations: {} # @schema description: Annotations to add to the service account

  # @schema description: RBAC configuration
  rbac:
    create: true # @schema description: Create RBAC resources

  # @schema description: Pod security context
  podSecurityContext: {}

  # @schema description: Config reloader configuration
  configReloader:
    enabled: true # @schema description: Enable config reloader

  # @schema description: Container security context
  securityContext:
    runAsNonRoot: true # @schema description: Run container as non-root user
    allowPrivilegeEscalation: false # @schema description: Prevent privilege escalation
    readOnlyRootFilesystem: true # @schema description: Mount root filesystem as read-only

  # @schema description: Resource requests and limits
  resources:
    requests:
      cpu: 1 # @schema description: CPU request (e.g., "200m", "1", "2"); anyOf: [{"type": "string"}, {"type": "number"}]
      memory: 1Gi # @schema description: Memory request
    limits:
      cpu: 2 # @schema description: CPU limit (e.g., "200m", "1", "2"); anyOf: [{"type": "string"}, {"type": "number"}]
      memory: 4Gi # @schema description: Memory limit

  # @schema description: Node selector for pod assignment
  nodeSelector: {}

  # @schema description: Tolerations for pod assignment
  tolerations: []

  # @schema description: Affinity rules for pod assignment
  affinity: {}

  # @schema description: Ingress configuration
  ingress:
    enabled: false # @schema description: Enable ingress
    annotations: {} # @schema description: Annotations for the ingress
    hosts: [] # @schema description: Ingress hosts
    tls: [] # @schema description: TLS configuration

  # @schema description: Pod annotations
  podAnnotations: {}

  # @schema description: Pod labels
  podLabels: {}
