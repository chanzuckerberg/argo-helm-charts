suite: test loki dashboard
templates:
  - templates/dashboard.yaml
tests:
  - it: renders GrafanaDashboard when enabled
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: GrafanaDashboard
      - equal:
          path: metadata.name
          value: loki-monitoring
      - equal:
          path: spec.instanceSelector.matchLabels.app
          value: grafana
      - equal:
          path: spec.folderRef
          value: loki
  - it: does not render when chart disabled
    set:
      enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: reflects overridden values in dashboard JSON and selector
    set:
      grafana:
        name: grafana-override
      loki:
        namespace: custom-ns
        uid: custom-uid
        dashboardTitle: Custom Title
    asserts:
      - equal:
          path: spec.instanceSelector.matchLabels.app
          value: grafana-override
      - equal:
          path: metadata.name
          value: loki-monitoring
  - it: reflects cw-loki namespace in all dashboard PromQL queries
    set:
      loki:
        namespace: cw-loki
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: GrafanaDashboard
