suite: test nodepool
templates:
  - nodepool.yaml
tests:
  - it: should create NodePool when enabled is true (default)
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: NodePool
      - containsDocument:
          apiVersion: karpenter.sh/v1
          kind: NodePool
          name: gpu-workloads

  - it: should not create NodePool when disabled
    set:
      nodepool:
        enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should have correct metadata
    asserts:
      - equal:
          path: metadata.name
          value: gpu-workloads
      - equal:
          path: apiVersion
          value: karpenter.sh/v1
      - equal:
          path: kind
          value: NodePool

  - it: should have correct labels
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: karpenter-gpu-nodepool
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - equal:
          path: metadata.labels["app.kubernetes.io/managed-by"]
          value: Helm

  - it: should use default disruption policy
    asserts:
      - equal:
          path: spec.disruption.consolidationPolicy
          value: WhenEmptyOrUnderutilized
      - equal:
          path: spec.disruption.consolidateAfter
          value: 30s

  - it: should allow custom disruption policy
    set:
      nodepool:
        disruption:
          consolidationPolicy: WhenEmpty
          consolidateAfter: 60s
    asserts:
      - equal:
          path: spec.disruption.consolidationPolicy
          value: WhenEmpty
      - equal:
          path: spec.disruption.consolidateAfter
          value: 60s

  - it: should have correct node labels
    asserts:
      - equal:
          path: spec.template.metadata.labels["workload.type"]
          value: gpu
      - equal:
          path: spec.template.metadata.labels["workload.node-purpose"]
          value: gpu

  - it: should allow custom node labels
    set:
      nodepool:
        template:
          metadata:
            labels:
              custom-label: custom-value
              workload.type: ml
    asserts:
      - equal:
          path: spec.template.metadata.labels["custom-label"]
          value: custom-value
      - equal:
          path: spec.template.metadata.labels["workload.type"]
          value: ml

  - it: should have correct nodeClassRef
    asserts:
      - equal:
          path: spec.template.spec.nodeClassRef.group
          value: karpenter.k8s.aws
      - equal:
          path: spec.template.spec.nodeClassRef.kind
          value: EC2NodeClass
      - equal:
          path: spec.template.spec.nodeClassRef.name
          value: default

  - it: should allow custom nodeClassRef
    set:
      nodepool:
        template:
          spec:
            nodeClassRef:
              name: custom-nodeclass
    asserts:
      - equal:
          path: spec.template.spec.nodeClassRef.name
          value: custom-nodeclass

  - it: should have startup taints
    asserts:
      - isNotEmpty:
          path: spec.template.spec.startupTaints
      - contains:
          path: spec.template.spec.startupTaints
          content:
            key: ebs.csi.aws.com/agent-not-ready
            effect: NoSchedule
      - contains:
          path: spec.template.spec.startupTaints
          content:
            key: efs.csi.aws.com/agent-not-ready
            effect: NoSchedule

  - it: should have GPU instance family requirements
    asserts:
      - contains:
          path: spec.template.spec.requirements
          content:
            key: karpenter.k8s.aws/instance-family
            operator: In
            values:
              - g4dn
              - g5
              - g6
              - g6e
              - p4d
              - p4de
              - p5

  - it: should have GPU count requirement
    asserts:
      - contains:
          path: spec.template.spec.requirements
          content:
            key: karpenter.k8s.aws/instance-gpu-count
            operator: NotIn
            values:
              - "0"

  - it: should have capacity type requirement
    asserts:
      - contains:
          path: spec.template.spec.requirements
          content:
            key: karpenter.sh/capacity-type
            operator: In
            values:
              - on-demand

  - it: should allow custom requirements
    set:
      nodepool:
        template:
          spec:
            requirements:
              - key: karpenter.sh/capacity-type
                operator: In
                values:
                  - spot
    asserts:
      - contains:
          path: spec.template.spec.requirements
          content:
            key: karpenter.sh/capacity-type
            operator: In
            values:
              - spot

  - it: should have workload.gpu taint
    asserts:
      - contains:
          path: spec.template.spec.taints
          content:
            key: workload.gpu
            value: "true"
            effect: NoSchedule

  - it: should have expireAfter set
    asserts:
      - equal:
          path: spec.template.spec.expireAfter
          value: 24h

  - it: should allow custom expireAfter
    set:
      nodepool:
        template:
          spec:
            expireAfter: 48h
    asserts:
      - equal:
          path: spec.template.spec.expireAfter
          value: 48h

  - it: should use custom NodePool name
    set:
      nodepool:
        name: ml-workloads
    asserts:
      - equal:
          path: metadata.name
          value: ml-workloads

