# Example: Mixed capacity (spot and on-demand) with multiple GPU families
# This configuration allows Karpenter to choose between spot and on-demand for cost optimization

nodepool:
  enabled: true
  name: gpu-flexible
  
  disruption:
    consolidationPolicy: WhenEmptyOrUnderutilized
    consolidateAfter: 30s
  
  template:
    metadata:
      labels:
        workload.type: gpu
        workload.node-purpose: gpu
        capacity-strategy: mixed
    
    spec:
      expireAfter: 24h
      
      nodeClassRef:
        group: karpenter.k8s.aws
        kind: EC2NodeClass
        name: default
      
      startupTaints:
        - key: ebs.csi.aws.com/agent-not-ready
          effect: NoSchedule
        - key: efs.csi.aws.com/agent-not-ready
          effect: NoSchedule
      
      requirements:
        - key: kubernetes.io/arch
          operator: In
          values:
            - amd64
            - arm64
        - key: kubernetes.io/os
          operator: In
          values:
            - linux
        - key: karpenter.sh/capacity-type
          operator: In
          values:
            - spot
            - on-demand
        - key: karpenter.k8s.aws/instance-family
          operator: In
          values:
            - g4dn
            - g5
            - g6
        - key: karpenter.k8s.aws/instance-gpu-count
          operator: NotIn
          values:
            - "0"
      
      taints:
        - key: workload.gpu
          value: "true"
          effect: NoSchedule

nvidiaDriver:
  enabled: true
  image:
    repository: nvcr.io/nvidia/k8s-device-plugin
    tag: v0.18.0
    pullPolicy: IfNotPresent
  
  args:
    - "--fail-on-init-error=false"
    - "--device-list-strategy=volume-mounts"

