{{- $global := . }}
{{- $globalValues := dict "Chart" $global.Chart "Release" $global.Release "Capabilities" $global.Capabilities "Values" $global.Values.global }}
{{- with $globalValues }}
{{- if and .Values.grafanaDashboard .Values.grafanaDashboard.enabled .Values.argusMetadata .Values.argusMetadata.stackName .Values.argusMetadata.appName .Values.argusMetadata.envName }}
{{- $rootFolderName := printf "argus-%s" .Values.argusMetadata.stackName }}
{{- $rootFolderTitle := "Argus" }}
{{- $appFolderName := printf "%s-%s" .Values.argusMetadata.appName .Values.argusMetadata.stackName }}
{{- $appFolderTitle := .Values.argusMetadata.appName -}}
{{- $envFolderName := printf "%s-%s-%s" .Values.argusMetadata.appName .Values.argusMetadata.envName .Values.argusMetadata.stackName }}
{{- $envFolderTitle := .Values.argusMetadata.envName -}}
---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaFolder
metadata:
  name: {{ $rootFolderName }}
spec:
  allowCrossNamespaceImport: true
  resyncPeriod: 30s
  instanceSelector:
    {{- toYaml .Values.grafanaDashboard.instanceSelector | nindent 4 }}
  title: {{ $rootFolderTitle }}
  uid: {{ $rootFolderTitle | lower }}
---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaFolder
metadata:
  name: {{ $appFolderName }}
spec:
  allowCrossNamespaceImport: true
  resyncPeriod: 30s
  instanceSelector:
    {{- toYaml .Values.grafanaDashboard.instanceSelector | nindent 4 }}
  parentFolderRef: {{ $rootFolderName }}
  title: {{ $appFolderTitle }}
  uid: {{ $appFolderTitle | lower }}
---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaFolder
metadata:
  name: {{ $envFolderName }}
spec:
  allowCrossNamespaceImport: true
  resyncPeriod: 30s
  instanceSelector:
    {{- toYaml .Values.grafanaDashboard.instanceSelector | nindent 4 }}
  parentFolderRef: {{ $appFolderName }}
  title: {{ $envFolderTitle }}
  uid: {{ printf "%s-%s" $appFolderTitle $envFolderTitle | lower }}
---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDashboard
metadata:
  name: {{ include "stack.fullname" . | lower }}-dashboard
spec:
  allowCrossNamespaceImport: true
  resyncPeriod: 30s
  instanceSelector:
    {{- toYaml .Values.grafanaDashboard.instanceSelector | nindent 4 }}
  folderRef: {{ $envFolderName }}
  json: |
    {{- include "stack.grafanaDashboard.json" $global | nindent 4 }}
{{- end }}
{{- end }}
