{{ $global := . }}
{{ $globalValues := dict "Chart" $global.Chart "Release" $global.Release "Capabilities" $global.Capabilities "Values" $global.Values.global }}
{{- with $globalValues }}
{{- if .Values.grafanaDashboard.enabled -}}
{{- $rootFolder := "argus" }}
{{- $appFolder := .Values.argusMetadata.appName }}
{{- $envFolder := printf "%s-%s" .Values.argusMetadata.appName .Values.argusMetadata.envName }}
---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaFolder
metadata:
  name: {{ $rootFolder }}
spec:
  instanceSelector:
    matchLabels:
      name: central-grafana
  title: {{ $rootFolder }}
---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaFolder
metadata:
  name: {{ $appFolder }}
spec:
  instanceSelector:
    matchLabels:
      name: central-grafana
  title: {{ $appFolder }}
  parentFolderRef: {{ $rootFolder }}
---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaFolder
metadata:
  name: {{ $envFolder }}
spec:
  instanceSelector:
    matchLabels:
      name: central-grafana
  title: {{ $envFolder }}
  parentFolderRef: {{ $appFolder }}
---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDashboard
metadata:
  name: {{ include "stack.fullname" . | lower }}-dashboard
spec:
  allowCrossNamespaceImport: true
  resyncPeriod: 30s
  instanceSelector:
    matchLabels:
      app: grafana
  parentFolderRef: {{ $envFolder }}
  json: |
    {{- include "stack.grafanaDashboard.json" $global | nindent 4 }}
---
{{ end }}
{{- end }}
