# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test jobs
templates:
  - job.yaml
tests:
  - it: should work
    set:
      jobs:
        job1:
          activeDeadlineSeconds: 300
          backoffLimit: 2
          completions: 5
          parallelism: 3
          serviceAccount:
            create: true
            annotations:
              "eks.amazonaws.com/role-arn": some-role
          image:
            repository: my-repo
            tag: sha-mytag
          command: ["hello-world"]
          args: ["arg1", "arg2"]
    asserts:
      - hasDocuments:
          count: 2
      - documentIndex: 0
        containsDocument:
          apiVersion: batch/v1
          kind: Job
          name: "release-name-stack-job1"
        template: job.yaml
      - documentIndex: 0
        equal:
          path: metadata.name
          value: "release-name-stack-job1"
      - documentIndex: 0
        equal:
          path: spec.template.spec.containers[0].image
          value: "my-repo:sha-mytag"
      - documentIndex: 0
        equal:
          path: spec.template.spec.containers[0].command
          value: ["hello-world"]
      - documentIndex: 0
        equal:
          path: spec.template.spec.containers[0].args
          value: ["arg1", "arg2"]
      - documentIndex: 0
        equal:
          path: spec.activeDeadlineSeconds
          value: 300
      - documentIndex: 0
        equal:
          path: spec.backoffLimit
          value: 2
      - documentIndex: 0
        equal:
          path: spec.completions
          value: 5
      - documentIndex: 0
        equal:
          path: spec.parallelism
          value: 3
      - documentIndex: 1
        containsDocument:
          apiVersion: v1
          kind: ServiceAccount
          name: "release-name-stack-job1"
      - documentIndex: 1
        equal:
          path: metadata.name
          value: "release-name-stack-job1"
      - documentIndex: 1
        equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: "some-role"
      - documentIndex: 1
        equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: "stack"
      - documentIndex: 1
        equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: "RELEASE-NAME"
      - documentIndex: 1
        equal:
          path: metadata.labels["app.kubernetes.io/version"]
          value: "1.16.0"
      - documentIndex: 1
        equal:
          path: metadata.labels["app.kubernetes.io/managed-by"]
          value: "Helm"
      - documentIndex: 1
        equal:
          path: metadata.labels["app.kubernetes.io/service"]
          value: "release-name-stack-job1"
      - documentIndex: 1
        equal:
          path: automountServiceAccountToken
          value: true
  - it: should not make service account for job
    set:
      jobs:
        job2:
          image:
            repository: my-repo
            tag: sha-mytag
          command: ["hello-world"]
          args: ["arg1", "arg2"]
    asserts:
      - hasDocuments:
          count: 1
      - containsDocument:
          apiVersion: batch/v1
          kind: Job
          name: "release-name-stack-job2"
        template: job.yaml
      - containsDocument:
          apiVersion: v1
          kind: ServiceAccount
          name: "release-name-stack-job2"
        not: true
  
  - it: uses ports if provided and autofill name or protocol with default value if left empty
    set:
      jobs:
        job1:
          image:
            repository: test-ports
            tag: sha-mytag
          command: ["hello-world"]
          args: ["arg1", "arg2"]
          service:
            ports:
              - name: http
                containerPort: 8080
              - name: metrics
                containerPort: 9090
                protocol: TCP
            
    asserts:
      - lengthEqual:
          path:  spec.template.spec.containers[0].ports
          count: 2
      - equal:
          path: spec.template.spec.containers[0].ports[0]
          value: 
            name: http
            containerPort: 8080
            protocol: TCP
      - equal:
          path: spec.template.spec.containers[0].ports[1]
          value:
            name: metrics
            containerPort: 9090
            protocol: TCP
  
  - it: uses port if ports not provided (legacy behavior for backward compatibility)
    set:
      jobs:
        job2:
          image:
            repository: test-ports
            tag: sha-mytag
          command: ["hello-world"]
          args: ["arg1", "arg2"]
          service:
            port: 3000

    asserts:
      - lengthEqual:
          path:  spec.template.spec.containers[0].ports
          count: 1
      - equal:
          path: spec.template.spec.containers[0].ports[0]
          value: 
            name: http
            containerPort: 3000
            protocol: TCP
  
  - it: ensure there would be default port 80 if no ports or port is provided
    set:
      jobs:
        job1:
          args: ["arg1", "arg2"]
          command: ["command1", "command2"]

    asserts:
      - lengthEqual:
          path:  spec.template.spec.containers[0].ports
          count: 1
      - equal:
          path: spec.template.spec.containers[0].ports[0]
          value: 
            name: http
            containerPort: 80
            protocol: TCP