# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: oidc proxy deployment
templates:
  - oidc_proxy.yaml
tests:
  - it: can be disabled with oidcProxy.enabled=false
    set:
      global:
        oidcProxy:
          enabled: false
    asserts:
      - hasDocuments:
          count: 0
  - it: is enabled by default
    asserts:
      - hasDocuments:
          count: 3
  - it: sets additionalSecrets in envFrom
    set:
      global:
        oidcProxy:
          additionalSecrets:
            - secretRef:
              name: blah1
              optional: true
            - secretRef:
              name: blah2
              optional: true
    asserts:
      - documentIndex: 0
        lengthEqual:
          path: spec.template.spec.containers[0].envFrom
          count: 2
  - it: combines additionalSecrets with argus secrets in envFrom
    set:
      global:
        appSecrets:
          envSecret:
            secretName: blah3
          stackSecret:
            secretName: blah4
        oidcProxy:
          additionalSecrets:
            - secretRef:
              name: blah1
              optional: true
            - secretRef:
              name: blah2
              optional: true
    asserts:
      - documentIndex: 0
        lengthEqual:
          path: spec.template.spec.containers[0].envFrom
          count: 4

  - it: defaults to 0 envFrom object
    asserts:
      - documentIndex: -1
        lengthEqual:
          path: spec.template.spec.containers[0].envFrom
          count: 0
