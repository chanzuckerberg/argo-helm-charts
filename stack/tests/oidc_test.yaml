# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: oidc proxy deployment
templates:
  - oidc_proxy.yaml
tests:
  - it: can be disabled with oidcProxy.enabled=false
    set:
      global:
        oidcProxy:
          enabled: false
    asserts:
      - hasDocuments:
          count: 0
  - it: make the appropriate resources when enabled
    set:
      global:
        oidcProxy:
          enabled: true
    asserts:
      - hasDocuments:
          count: 3
      - documentIndex: 0
        containsDocument:
          kind: Deployment
          apiVersion: apps/v1
          name: release-name-stack-oidc-proxy
      - documentIndex: 1
        containsDocument:
          kind: Service
          apiVersion: v1
          name: release-name-stack-oidc-proxy
      - documentIndex: 2
        containsDocument:
          kind: Ingress
          apiVersion: networking.k8s.io/v1
          name: release-name-stack-oidc-proxy
  - it: disabled by default
    asserts:
      - hasDocuments:
          count: 0
  - it: sets additionalSecrets in envFrom
    set:
      global:
        appSecrets:
          envSecret:
            secretName: blah3
          stackSecret:
            secretName: blah4
          clusterSecret:
            secretName: blah5
        oidcProxy:
          enabled: true
          additionalSecrets:
            - secretRef:
              name: blah1
              optional: true
            - secretRef:
              name: blah2
              optional: true
    asserts:
      - documentIndex: 0
        lengthEqual:
          path: spec.template.spec.containers[0].envFrom
          count: 5
  - it: combines additionalSecrets with argus secrets in envFrom
    set:
      global:
        appSecrets:
          envSecret:
            secretName: blah3
          stackSecret:
            secretName: blah4
          clusterSecret:
            secretName: blah5
        oidcProxy:
          enabled: true
          additionalSecrets:
            - secretRef:
              name: blah1
              optional: true
            - secretRef:
              name: blah2
              optional: true
    asserts:
      - documentIndex: 0
        lengthEqual:
          path: spec.template.spec.containers[0].envFrom
          count: 5
  - it: defaults to 0 envFrom object
    set:
      global:
        oidcProxy:
          enabled: true
    asserts:
      - documentIndex: 0
        equal:
          path: spec.template.spec.containers[0].envFrom
          value: []
  - it: sets extraArgs properly
    set:
      global:
        oidcProxy:
          enabled: true
          extraArgs:
            - "--skip-auth-route=/v1/api/docs"
            - "--skip-auth-route=/v1/api/security/access_token"
    asserts:
      - documentIndex: 0
        lengthEqual:
          path: spec.template.spec.containers[0].args
          count: 14
      - documentIndex: 0
        equal:
          path: spec.template.spec.containers[0].args[12]
          value: "--skip-auth-route=/v1/api/docs"
      - documentIndex: 0
        equal:
          path: spec.template.spec.containers[0].args[13]
          value: "--skip-auth-route=/v1/api/security/access_token"
  - it: overwrites the name
    set:
      global:
        oidcProxy:
          enabled: true
        fullnameOverride: "overwrittenfull"
      services:
        service1:
          args: ["arg1", "arg2"]
          command: ["command1", "command2"]
          autoscaling:
            enabled: true
            minReplicas: 2
            maxReplicas: 10
            maxUnavailable: 1
          replicaCount: 2
          sidecars:
            - name: sidecar1
              image: "sidecar1:latest"
            - name: sidecar2
              image: "sidecar2:latest"
          initContainers:
            - name: initContainer1
              image: "alpine:latest"
              command: ["echo", "Hello World"]
    asserts:
      - equal:
          path: metadata.name
          value: "overwrittenfull-oidc-proxy"
