# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test deployment
templates:
  - deployment.yaml
  - serviceaccount_initContainer.yaml
tests:
  - it: should create serviceAccount for initContainer and it should be different from serviceAccount of main container
    set:
      services:
        service1:
          serviceAccount: 
            name: "service1"
            create: true
          initContainers:
            - name: initContainer1
              image:
                repository: "node"
                tag: "20.0.0"
              serviceAccount: 
                create: true
                annotations:
                  "eks.amazonaws.com/role-arn": some-role
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: "service1"
        template: deployment.yaml
      - equal:
          path: spec.template.spec.initContainers[0].serviceAccountName
          value: "release-name-stack-initContainer1"
        template: deployment.yaml
      - equal:
          path: metadata.name
          value: "release-name-stack-initContainer1"
        template: serviceaccount_initContainer.yaml
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: "some-role"
        template: serviceaccount_initContainer.yaml
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: "stack"
        template: serviceaccount_initContainer.yaml
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: "RELEASE-NAME"
        template: serviceaccount_initContainer.yaml
      - equal:
          path: metadata.labels["app.kubernetes.io/version"]
          value: "1.16.0"
        template: serviceaccount_initContainer.yaml
      - equal:
          path: metadata.labels["app.kubernetes.io/managed-by"]
          value: "Helm"
        template: serviceaccount_initContainer.yaml
      - equal:
          path: metadata.labels["app.kubernetes.io/service"]
          value: "release-name-stack-initcontainer1"
        template: serviceaccount_initContainer.yaml
      - equal:
          path: automountServiceAccountToken
          value: true
        template: serviceaccount_initContainer.yaml
  
  - it: should not create serviceAccount for initContainer
    set:
      services:
        service1:
          initContainers:
            - name: initContainer2
              image:
                repository: "node"
                tag: "20.0.0"
              serviceAccount: 
                name: "some-service-initContainer2-serviceAccount"
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].serviceAccountName
          value: "some-service-initContainer2-serviceAccount"
        template: deployment.yaml
      - hasDocuments:
          count: 0
        template: serviceaccount_initContainer.yaml
  
  - it: should not have serviceAccountName field
    set:
      services:
        service1:
          initContainers:
            - name: initContainer2
              image:
                repository: "node"
                tag: "20.0.0"
    asserts:
      - notExists:
          path: spec.template.spec.initContainers[0].serviceAccountName
        template: deployment.yaml
      - hasDocuments:
          count: 0
        template: serviceaccount_initContainer.yaml

