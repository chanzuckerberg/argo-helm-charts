# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test ingress
templates:
  - ingress.yaml
tests:
  - it: adds nginx auth annotations when oidcProxy.enabled=true
    set:
      global:
        ingress:
          host: "stack.play.dev.czi.team"
        oidcProxy:
          enabled: true
      services:
        service1:
          ingress:
            oidcProtected: true
    asserts:
      - isKind:
          of: Ingress
      - documentIndex: 0
        equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/auth-url"]
          value: "http://release-name-stack-oidc-proxy.NAMESPACE.svc.cluster.local:4180/oauth2/auth"
      - documentIndex: 0
        equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/auth-signin"]
          value: "https://stack.play.dev.czi.team/oauth2/start?rd=https://$host$escaped_request_uri"
      - documentIndex: 0
        equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/auth-response-headers"]
          value: "Authorization,X-Auth-Request-User,X-Auth-Request-Groups,X-Auth-Request-Email,X-Auth-Request-Preferred-Username"
  - it: adds additional nginx auth headers when using additionalHeaders
    set:
      global:
        ingress:
          host: "stack.play.dev.czi.team"
        oidcProxy:
          enabled: true
          additionalHeaders:
            - X-Forwarded-User
            - blahblahblah
      services:
        service1:
          ingress:
            oidcProtected: true
    asserts:
      - isKind:
          of: Ingress
      - documentIndex: 0
        equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/auth-response-headers"]
          value: "Authorization,X-Auth-Request-User,X-Auth-Request-Groups,X-Auth-Request-Email,X-Auth-Request-Preferred-Username,X-Forwarded-User,blahblahblah"
  - it: adds auth-snippet with using skipAuth
    set:
      global:
        ingress:
          host: "stack.play.dev.czi.team"
        oidcProxy:
          enabled: true
          skipAuth:
            - path: /healthz
              method: GET
            - path: /api/*
              method: "*"
      services:
        service1:
          ingress:
            oidcProtected: true
    asserts:
      - isKind:
          of: Ingress
      - documentIndex: 0
        equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/auth-snippet"]
          value: |
            set $skip_auth_get_healthz 1;

            if ( $request_uri !~ "/healthz" ) {
                set $skip_auth_get_healthz  0;
            }

            if ( $request_method !~ "GET" ) {
                set $skip_auth_get_healthz  0;
            }

            if ( $skip_auth_get_healthz ) {
                return 200;
            }
            set $skip_auth___api_ 1;

            if ( $request_uri !~ "/api/*" ) {
                set $skip_auth___api_  0;
            }

            if ( $request_method !~ "*" ) {
                set $skip_auth___api_  0;
            }

            if ( $skip_auth___api_ ) {
                return 200;
            }
