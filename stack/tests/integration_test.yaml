suite: test deployment, preview/active service and rollout integration
templates:
  - "*.yaml"
tests:
  - it: when deploymentKind is Deployment, should only render deployment and active service
    set:
      global:
        deploymentKind: Deployment
        argoBuildEnv:
          appNamespace: "argus-testapp-rdev"
      services:
        service1:
          image:
            repository: "your-app"
            tag: "latest"
    asserts:
      - hasDocuments:
          count: 1
        template: deployment.yaml
      - hasDocuments:
          count: 1
        template: service.yaml
      - hasDocuments:
          count: 0
        template: rollout.yaml
      - hasDocuments:
          count: 0
        template: preview_service.yaml

  - it: when deploymentKind is rollout, should only render rollout and both active/preview service
    set:
      global:
        deploymentKind: Rollout
        argoBuildEnv:
          appNamespace: "argus-testapp-rdev"
      services:
        service1:
          image:
            repository: "your-app"
            tag: "latest"
    asserts:
      - hasDocuments:
          count: 0
        template: deployment.yaml
      - hasDocuments:
          count: 1
        template: service.yaml
      - hasDocuments:
          count: 1
        template: rollout.yaml
      - hasDocuments:
          count: 1
        template: preview_service.yaml

  - it: should include argus/env-name label in all resources when argusMetadata.envName is set
    set:
      global:
        deploymentKind: Deployment
        argusMetadata:
          envName: "integration-env"
        argoBuildEnv:
          appNamespace: "argus-testapp-rdev"
      services:
        service1:
          image:
            repository: "your-app"
            tag: "latest"
    asserts:
      - equal:
          path: metadata.labels["argus/env-name"]
          value: "integration-env"
        template: deployment.yaml
      - equal:
          path: metadata.labels["argus/env-name"]
          value: "integration-env"
        template: service.yaml