# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test CiliumNetworkPolicy
templates:
  - ciliumnp.yaml
tests:
  - it: should not create CiliumNetworkPolicy when ciliumNetworkPolicy.enabled is false
    set:
      services:
        service1:
          ciliumNetworkPolicy:
            enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should create CiliumNetworkPolicy when ciliumNetworkPolicy.enabled is true
    set:
      global:
        ciliumNetworkPolicy:
          enabled: true
      services:
        service1:
          args: ["arg1", "arg2"]
          command: ["command1", "command2"]
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: CiliumNetworkPolicy
      - containsDocument:
          apiVersion: cilium.io/v2
          kind: CiliumNetworkPolicy

  - it: should set correct metadata name
    set:
      global:
        ciliumNetworkPolicy:
          enabled: true
      services:
        service1:
          args: ["arg1", "arg2"]
    asserts:
      - equal:
          path: metadata.name
          value: "release-name-stack-service1"

  - it: should include service labels
    set:
      global:
        ciliumNetworkPolicy:
          enabled: true
      services:
        service1:
          args: ["arg1", "arg2"]
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: "stack"
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: "RELEASE-NAME"
      - equal:
          path: metadata.labels["app.kubernetes.io/service"]
          value: "release-name-stack-service1"

  - it: should include argus/env-name label when argusMetadata.envName is set
    set:
      global:
        ciliumNetworkPolicy:
          enabled: true
        argusMetadata:
          envName: "production"
      services:
        service1:
          args: ["arg1", "arg2"]
    asserts:
      - equal:
          path: metadata.labels["argus/env-name"]
          value: "production"

  - it: should include all argus metadata labels
    set:
      global:
        ciliumNetworkPolicy:
          enabled: true
        argusMetadata:
          appName: "test-app"
          envName: "staging"
          stackName: "test-stack"
          repoName: "test-repo"
          repoOwner: "test-owner"
      services:
        service1:
          args: ["arg1", "arg2"]
    asserts:
      - equal:
          path: metadata.labels["argus/app-name"]
          value: "test-app"
      - equal:
          path: metadata.labels["argus/env-name"]
          value: "staging"
      - equal:
          path: metadata.labels["argus/stack-name"]
          value: "test-stack"
      - equal:
          path: metadata.labels["argus/repo-name"]
          value: "test-repo"
      - equal:
          path: metadata.labels["argus/repo-owner"]
          value: "test-owner"

  - it: should set endpointSelector with argus labels
    set:
      global:
        ciliumNetworkPolicy:
          enabled: true
        argusMetadata:
          envName: "production"
          appName: "myapp"
      services:
        service1:
          args: ["arg1", "arg2"]
    asserts:
      - equal:
          path: spec.endpointSelector.matchLabels["argus/env-name"]
          value: "production"
      - equal:
          path: spec.endpointSelector.matchLabels["argus/app-name"]
          value: "myapp"

  - it: should set fromEndpoints with argus labels
    set:
      global:
        ciliumNetworkPolicy:
          enabled: true
        argusMetadata:
          envName: "test"
          stackName: "mystack"
      services:
        service1:
          args: ["arg1", "arg2"]
    asserts:
      - equal:
          path: spec.ingress[0].fromEndpoints[0].matchLabels["argus/env-name"]
          value: "test"
      - equal:
          path: spec.ingress[0].fromEndpoints[0].matchLabels["argus/stack-name"]
          value: "mystack"

  - it: should have correct description
    set:
      global:
        ciliumNetworkPolicy:
          enabled: true
      services:
        service1:
          args: ["arg1", "arg2"]
    asserts:
      - equal:
          path: spec.description
          value: "L3-L4 policy to restrict access to release-name-stack-service1"

  - it: should work with fullnameOverride
    set:
      global:
        ciliumNetworkPolicy:
          enabled: true
        fullnameOverride: "overwrittenfull"
      services:
        service1:
          args: ["arg1", "arg2"]
    asserts:
      - equal:
          path: metadata.name
          value: "overwrittenfull-service1"
      - equal:
          path: spec.description
          value: "L3-L4 policy to restrict access to overwrittenfull-service1"

  - it: should create multiple policies for multiple services
    set:
      global:
        ciliumNetworkPolicy:
          enabled: true
      services:
        service1:
          args: ["arg1", "arg2"]
        service2:
          args: ["arg3", "arg4"]
    asserts:
      - hasDocuments:
          count: 2
      - documentIndex: 0
        equal:
          path: metadata.name
          value: "release-name-stack-service1"
      - documentIndex: 1
        equal:
          path: metadata.name
          value: "release-name-stack-service2"

  - it: should include annotations
    set:
      global:
        ciliumNetworkPolicy:
          enabled: true
        annotations:
          custom-annotation: "test-value"
      services:
        service1:
          args: ["arg1", "arg2"]
    asserts:
      - equal:
          path: metadata.annotations["custom-annotation"]
          value: "test-value"
