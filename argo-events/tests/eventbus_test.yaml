# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test eventbus.yaml
templates:
  - eventbus.yaml

tests:
  - it: should render an jetstream event bus resource
    set:
      eventbus:
        jetstream:
          default:
            version: 2.7.3
            replicas: 1

    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: EventBus
      - equal:
          path: metadata.name
          value: default
      - equal:
          path: spec.jetstream
          value:
            replicas: 1
            version: "2.7.3"
  
  - it: should render an jetstream event bus resource with additional properties like persistent strategy or streamConfig
    set:
      eventbus:
        jetstream:
          special:
            version: 2.7.3
            persistence:
              volumeSize: 0.5Gi
            streamConfig: |
              replicas: 1

    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: EventBus
      - equal:
          path: metadata.name
          value: special
      - equal:
          path: spec.jetstream
          value:
            persistence:
              volumeSize: 0.5Gi
            replicas: 1
            streamConfig: |
              replicas: 1
            version: 2.7.3
  
  - it: should render a jetstream event bus with all optional fields
    set:
      eventbus:
        jetstream:
          full:
            version: "2.7.3"
            persistence:
              volumeSize: 1Gi
              storageClassName: "my-storage-class"
            streamConfig: |
              replicas: 1
              maxBytes: 1024
            affinity:
              nodeAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  nodeSelectorTerms:
                  - matchExpressions:
                    - key: kubernetes.io/os
                      operator: In
                      values:
                      - linux
            tolerations:
              - key: "my-key"
                operator: "Equal"
                value: "my-value"
                effect: "NoSchedule"
            metricsExporter:
              enabled: true
            nodeSelector:
              beta.kubernetes.io/os: linux
            containerTemplate:
              resources:
                limits:
                  cpu: 100m
            imagePullSecrets:
              - name: "my-secret"
            maxPayload: 2048
            metadata:
              annotations:
                my-annotation: "test-annotation"
            priority: 100
            priorityClassName: "high-priority"
            reloaderContainerTemplate:
              resources:
                limits:
                  cpu: 50m
            securityContext:
              runAsNonRoot: true
            serviceAccountName: "my-sa"
            settings: |
              server_name: "my-nats"
            startArgs:
              - "-D"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: EventBus
      - equal:
          path: spec.jetstream.version
          value: "2.7.3"
      - equal:
          path: spec.jetstream.persistence.volumeSize
          value: "1Gi"
      - equal:
          path: spec.jetstream.persistence.storageClassName
          value: "my-storage-class"
      - equal:
          path: spec.jetstream.streamConfig
          value: |
            replicas: 1
            maxBytes: 1024
      - equal:
          path: spec.jetstream.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].key
          value: "kubernetes.io/os"
      - equal:
          path: spec.jetstream.tolerations[0].key
          value: "my-key"
      - equal:
          path: spec.jetstream.metricsExporter.enabled
          value: true
      - equal:
          path: spec.jetstream.containerTemplate.resources.limits.cpu
          value: "100m"
      - equal:
          path: spec.jetstream.imagePullSecrets[0].name
          value: "my-secret"
      - equal:
          path: spec.jetstream.maxPayload
          value: "2048"
      - equal:
          path: spec.jetstream.metadata.annotations.my-annotation
          value: "test-annotation"
      - equal:
          path: spec.jetstream.priority
          value: 100
      - equal:
          path: spec.jetstream.priorityClassName
          value: "high-priority"
      - equal:
          path: spec.jetstream.reloaderContainerTemplate.resources.limits.cpu
          value: "50m"
      - equal:
          path: spec.jetstream.securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.jetstream.serviceAccountName
          value: "my-sa"
      - equal:
          path: spec.jetstream.settings
          value: |
            server_name: "my-nats"
      - equal:
          path: spec.jetstream.startArgs
          value:
            - "-D"
  
  - it: should render two jetstream event bus resources
    set:
      eventbus:
        jetstream:
          default:
            version: 2.7.3
            replicas: 1
          additional:
            version: 2.7.3
            replicas: 2

    asserts:
      - hasDocuments:
          count: 2
      - isKind:
          of: EventBus
      - documentIndex: 0
        equal:
          path: metadata.name
          value: additional
      - documentIndex: 0
        equal:
          path: spec.jetstream
          value:
            replicas: 2
            version: "2.7.3"  
      - documentIndex: 1
        equal:
          path: metadata.name
          value: default
      - documentIndex: 1
        equal:
          path: spec.jetstream
          value:
            replicas: 1
            version: "2.7.3"  
         
  - it: should render a kafka event bus
    set:
      eventbus:
        kafka:
          default:
            url: my-kafka:9092
            topic: my-topic
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: EventBus
      - equal:
          path: spec.kafka
          value:
            url: my-kafka:9092
            topic: my-topic
            version: 3.7.0

  - it: should render a kafka event with topic when topic is not set
    set:
      eventbus:
        kafka:
          additional:
            url: my-kafka:9092
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: EventBus
      - equal:
          path: spec.kafka
          value:
            url: my-kafka:9092
            topic: NAMESPACE-kafka-eventbus
            version: 3.7.0
  
  - it: should render when optional kakfa field is provided
    set:
      eventbus:
        kafka:
          default:
            url: model-iguana-11813-us1-kafka.upstash.io:9092
            topic: argo-kafka-eventbus
            version: 3.7.0
            tls:
              insecureSkipVerify: true
            sasl: 
              mechanism: SCRAM-SHA-256 
              userSecret: 
                name: kafka-secret
                key: username
              passwordSecret: 
                name: kafka-secret
                key: password
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: EventBus
      - equal:
          path: spec.kafka
          value:
            version: 3.7.0
            url: model-iguana-11813-us1-kafka.upstash.io:9092
            topic: argo-kafka-eventbus
            sasl:
              mechanism: SCRAM-SHA-256
              passwordSecret:
                key: password
                name: kafka-secret
              userSecret:
                key: username
                name: kafka-secret
            tls:
              insecureSkipVerify: true
  
  - it: should render two kafka event bus
    set:
      eventbus:
        kafka:
          default:
            url: my-kafka:9092
            topic: my-topic
          additional:
            url: my-kafka:9093
    asserts:
      - hasDocuments:
          count: 2
      - documentIndex: 0
        isKind:
          of:
            EventBus
      - documentIndex: 0
        equal:
          path: spec.kafka
          value:
            url: my-kafka:9093
            topic: NAMESPACE-kafka-eventbus
            version: 3.7.0
      - documentIndex: 1
        isKind:
          of:
            EventBus
      - documentIndex: 1
        equal:
          path: spec.kafka
          value:
            url: my-kafka:9092
            topic: my-topic
            version: 3.7.0
  
  - it: should render an Nats event bus resource
    set:
      eventbus:
        nats:
          default:
            native:
              replica: 1

    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: EventBus
      - equal:
          path: metadata.name
          value: default
      - equal:
          path: spec.nats
          value:
            native:
              replica: 1
