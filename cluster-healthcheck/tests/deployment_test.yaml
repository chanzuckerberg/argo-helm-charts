# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test deployment.yaml
templates:
  - deployment.yaml

tests:
  - it: should create a Deployment resource
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Deployment
      - containsDocument:
          apiVersion: apps/v1
          kind: Deployment

  - it: should have correct metadata
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-cluster-healthcheck
      - equal:
          path: metadata.namespace
          value: NAMESPACE

  - it: should have correct labels
    asserts:
      - equal:
          path: metadata.labels["helm.sh/chart"]
          value: cluster-healthcheck-0.1.0
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: cluster-healthcheck
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - equal:
          path: metadata.labels["app.kubernetes.io/managed-by"]
          value: Helm
      - isNotEmpty:
          path: metadata.labels["app.kubernetes.io/version"]

  - it: should use default replica count
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should use custom replica count when provided
    set:
      replicaCount: 5
    asserts:
      - equal:
          path: spec.replicas
          value: 5

  - it: should have correct selector labels
    asserts:
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/name"]
          value: cluster-healthcheck
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should have correct pod labels
    asserts:
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/name"]
          value: cluster-healthcheck
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should have default pod annotations
    asserts:
      - equal:
          path: spec.template.metadata.annotations["karpenter.sh/do-not-disrupt"]
          value: "true"

  - it: should use custom pod annotations when provided
    set:
      podAnnotations:
        custom-annotation: "custom-value"
    asserts:
      - equal:
          path: spec.template.metadata.annotations.custom-annotation
          value: "custom-value"

  - it: should have default priority class
    asserts:
      - equal:
          path: spec.template.spec.priorityClassName
          value: system-cluster-critical

  - it: should use custom priority class when provided
    set:
      priorityClassName: high-priority
    asserts:
      - equal:
          path: spec.template.spec.priorityClassName
          value: high-priority

  - it: should not set priority class when empty
    set:
      priorityClassName: ""
    asserts:
      - notExists:
          path: spec.template.spec.priorityClassName

  - it: should use default image
    asserts:
      - equal:
          path: spec.template.spec.containers[0].name
          value: http-echo
      - equal:
          path: spec.template.spec.containers[0].image
          value: hashicorp/http-echo:latest
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: IfNotPresent

  - it: should use custom image when provided
    set:
      image:
        repository: custom/echo
        tag: v1.0.0
        pullPolicy: Always
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: custom/echo:v1.0.0
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always

  - it: should have correct container args
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "-text=OK"
      - contains:
          path: spec.template.spec.containers[0].args
          content: "-listen=:8080"

  - it: should have correct container port
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 8080
      - equal:
          path: spec.template.spec.containers[0].ports[0].name
          value: http
      - equal:
          path: spec.template.spec.containers[0].ports[0].protocol
          value: TCP

  - it: should use custom target port in container and args
    set:
      service:
        targetPort: 9090
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 9090
      - contains:
          path: spec.template.spec.containers[0].args
          content: "-listen=:9090"

  - it: should have liveness probe
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /health
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 8080
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.periodSeconds
          value: 10

  - it: should have readiness probe
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /health
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: 8080
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
          value: 5
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.periodSeconds
          value: 5

  - it: should have default resources
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 100m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 64Mi
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 50m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 32Mi

  - it: should use custom resources when provided
    set:
      resources:
        limits:
          cpu: 200m
          memory: 128Mi
        requests:
          cpu: 100m
          memory: 64Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 200m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 128Mi
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 100m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 64Mi

  - it: should have default node affinity
    asserts:
      - isNotEmpty:
          path: spec.template.spec.affinity.nodeAffinity
      - equal:
          path: spec.template.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].key
          value: eks.amazonaws.com/compute-type
      - equal:
          path: spec.template.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].operator
          value: NotIn
      - contains:
          path: spec.template.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].values
          content: fargate

  - it: should use custom affinity when provided
    set:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - cluster-healthcheck
                topologyKey: kubernetes.io/hostname
    asserts:
      - isNotEmpty:
          path: spec.template.spec.affinity.podAntiAffinity

